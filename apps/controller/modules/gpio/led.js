//@ts-check

import Max7219 from "max7219-display";
import { order } from "../common.js";

/**
 * @typedef {"loading" | "order" | "playlistPreset"} DisplayMode
 */

const displayDriver = new Max7219({
    device: '/dev/spidev0.0',
    controllerCount: 1,
    flip: 'vertical',
    rotate: 0,
});
process.on("exit", () => displayDriver.clearAll())

let ms = 30;

/** @type {DisplayMode} */
let displayMode = "loading";

/** @param {DisplayMode} newMode */
export function setDisplayMode(newMode) {
    displayMode = newMode
}

export async function initLed() {
    await displayDriver.reset(0);

    let i = 0;
    setInterval(() => {
        switch (displayMode) {
            case "loading": {
                displayDriver.set(0, patterns.loading[i++]);
                i %= patterns.loading.length
                break
            }
            case "order": {
                if (order === undefined) return;
                displayDriver.set(0, patterns.order[order - 1]);
                break;
            }
            case "playlistPreset": {
                displayDriver.clear(0)
                // TODO: 実装
                break;
            }
        }
    }, ms);
}

/**
 * タグ付きテンプレートリテラル用の関数
 * 
 * @param {TemplateStringsArray} strings 
 * @param {unknown[]} variables
 * @returns {(0 | 1)[][]}
 */
function pattern(strings, ...variables) {
    const patternRegex = new RegExp(`^(?:(?:##|\.\.){8}\n){7}(?:##|\.\.){8}$`);

    const [firstString, ...restStrings] = [...strings];
    const pattern = (firstString + restStrings.map((str, i) => variables[i] + str).join(''))
        .trim()
        .replace(/\r/g, '')
        .replace(/^\s+/mg, '');
    const isOk = pattern.match(patternRegex) !== null;
    if (!isOk) throw new Error(`不正なパターン:\n${pattern}`);

    const result = pattern.split('\n')
        .map(rowStr => rowStr.replace(/(.)\1/g, '$1'))
        .map(rowStr => [...rowStr])
        .map(row => row.map(dot => dot === "#" ? 1 : 0))

    return result;
}


const patterns = {
    order: [
        pattern`
        ......####......
        ....######......
        ......####......
        ......####......
        ......####......
        ......####......
        ....########....
        ....########....
        `,
        pattern`
        ....########....
        ..############..
        ..####....####..
        ........######..
        ......######....
        ....######......
        ..############..
        ..############..
        `,
        pattern`
        ....########....
        ..############..
        ....##....####..
        ........######..
        ........######..
        ....##....####..
        ..############..
        ....########....
        `,
        pattern`
        ......########..
        ....##########..
        ..######..####..
        ..####....####..
        ..##############
        ..##############
        ..........####..
        ..........####..
        `,
    ],
    loading: [
        pattern`
        ....########....
        ..############..
        ..........######
        ............####
        ............####
        ............####
        ................
        ................
        `,
        pattern`
        ....########....
        ..############..
        ..........######
        ............####
        ............####
        ............####
        ............##..
        ................
        `,
        pattern`
        ....########....
        ....##########..
        ..........######
        ............####
        ............####
        ............####
        ............##..
        ................
        `,
        pattern`
        ......######....
        ......########..
        ..........######
        ............####
        ............####
        ..........######
        ..........####..
        ................
        `,
        pattern`
        ........####....
        ........######..
        ..........######
        ............####
        ............####
        ..........######
        ........######..
        ........####....
        `,
        pattern`
        ................
        ..........####..
        ..........######
        ............####
        ............####
        ..........######
        ......########..
        ......######....
        `,
        pattern`
        ................
        ............##..
        ..........######
        ............####
        ............####
        ..........######
        ....##########..
        ....########....
        `,
        pattern`
        ................
        ............##..
        ..........######
        ............####
        ............####
        ..........######
        ..############..
        ....########....
        `,
        pattern`
        ................
        ................
        ..........######
        ............####
        ............####
        ..........######
        ..############..
        ....########....
        `,
        pattern`
        ................
        ................
        ................
        ............####
        ............####
        ######....######
        ..############..
        ....########....
        `,
        pattern`
        ................
        ................
        ................
        ................
        ####........####
        ######....######
        ..############..
        ....########....
        `,
        pattern`
        ................
        ................
        ................
        ####............
        ####............
        ######....######
        ..############..
        ....########....
        `,
        pattern`
        ................
        ................
        ######..........
        ####............
        ####............
        ######..........
        ..############..
        ....########....
        `,
        pattern`
        ................
        ..##............
        ######..........
        ####............
        ####............
        ######..........
        ..############..
        ....########....
        `,
        pattern`
        ................
        ..##............
        ######..........
        ####............
        ####............
        ######..........
        ..##########....
        ....########....
        `,
        pattern`
        ....##..........
        ..####..........
        ######..........
        ####............
        ####............
        ######..........
        ..########......
        ....######......
        `,
        pattern`
        ....####........
        ..######........
        ######..........
        ####............
        ####............
        ######..........
        ..######........
        ....####........
        `,
        pattern`
        ....######......
        ..########......
        ######..........
        ####............
        ####............
        ######..........
        ..####..........
        ....##..........
        `,
        pattern`
        ....########....
        ..##########....
        ######..........
        ####............
        ####............
        ######..........
        ..##............
        ................
        `,
        pattern`
        ....########....
        ..############..
        ######..........
        ####............
        ####............
        ######..........
        ..##............
        ................
        `,
        pattern`
        ....########....
        ..############..
        ######..........
        ####............
        ####............
        ######..........
        ................
        ................
        `,
        pattern`
        ....########....
        ..############..
        ######....######
        ####............
        ####............
        ................
        ................
        ................
        `,
        pattern`
        ....########....
        ..############..
        ######....######
        ####........####
        ................
        ................
        ................
        ................
        `,
        pattern`
        ....########....
        ..############..
        ######....######
        ............####
        ............####
        ................
        ................
        ................
        `,
    ]
};